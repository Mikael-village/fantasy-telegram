<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚öîÔ∏è Fantasy Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --gold: #d4a843;
            --gold-dark: #b8860b;
            --gold-light: #f0d078;
            --red: #dc143c;
            --red-dark: #8b0000;
            --blue: #4169e1;
            --blue-dark: #1e3a8a;
            --bg: #0c0a08;
            --bg-panel: rgba(18, 15, 12, 0.98);
            --text: #e8dcc8;
            --text-dim: #8b7355;
            --border: #3d3529;
            --purple: #9370db;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            font-family: 'Crimson Text', serif;
            background: radial-gradient(ellipse at center top, #1a1614 0%, var(--bg) 60%, #000 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            text-align: center;
            padding: 20px 15px 15px;
            background: linear-gradient(180deg, rgba(184,134,11,0.15) 0%, transparent 100%);
            border-bottom: 2px solid var(--gold-dark);
        }

        .header h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.8em;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(212,168,67,0.4);
        }

        .header h1::before, .header h1::after {
            content: '‚öîÔ∏è';
            margin: 0 8px;
            font-size: 0.7em;
        }

        .header-sub {
            color: var(--text-dim);
            font-size: 1em;
            margin-top: 5px;
        }

        /* ===== CHARACTER ===== */
        .character-section {
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--purple);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--purple);
            animation: float 4s infinite ease-out;
            opacity: 0;
        }

        @keyframes float {
            0% { transform: translateY(0) scale(0); opacity: 0; }
            15% { opacity: 1; }
            85% { opacity: 0.6; }
            100% { transform: translateY(-180px) scale(0.3); opacity: 0; }
        }

        .particle:nth-child(1) { left: 15%; bottom: 30%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 30%; bottom: 25%; animation-delay: 0.8s; }
        .particle:nth-child(3) { left: 50%; bottom: 28%; animation-delay: 1.6s; }
        .particle:nth-child(4) { left: 70%; bottom: 25%; animation-delay: 2.4s; }
        .particle:nth-child(5) { left: 85%; bottom: 30%; animation-delay: 3.2s; }
        .particle:nth-child(6) { left: 40%; bottom: 22%; animation-delay: 1.2s; }

        .character-svg {
            width: 120px;
            height: 170px;
            filter: drop-shadow(0 0 25px var(--purple));
        }

        /* ===== ORBS ===== */
        .orbs-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 20px 0;
            width: 100%;
        }

        .orb {
            position: relative;
            width: 80px;
            height: 80px;
            animation: pulse 3s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .orb:nth-child(2) { animation-delay: 1.5s; }

        .orb-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #252220 0%, #0a0908 100%);
            border: 3px solid var(--border);
            box-shadow: inset 0 0 25px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        .orb-fill {
            position: absolute;
            bottom: 0;
            left: 5%;
            width: 90%;
            border-radius: 0 0 40px 40px;
            transition: height 0.5s;
        }

        .orb-hp .orb-fill {
            background: linear-gradient(180deg, var(--red) 0%, var(--red-dark) 100%);
            box-shadow: 0 0 15px rgba(220,20,60,0.5);
        }

        .orb-mana .orb-fill {
            background: linear-gradient(180deg, var(--blue) 0%, var(--blue-dark) 100%);
            box-shadow: 0 0 15px rgba(65,105,225,0.5);
        }

        .orb-glass {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(ellipse at 30% 25%, rgba(255,255,255,0.2) 0%, transparent 50%);
        }

        .orb-frame {
            position: absolute;
            width: 86px;
            height: 86px;
            top: -3px;
            left: -3px;
            border: 4px solid var(--gold-dark);
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(184,134,11,0.3);
        }

        .orb-value {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'MedievalSharp', cursive;
            font-size: 0.9em;
            color: #fff;
            text-shadow: 1px 1px 3px #000;
            z-index: 10;
        }

        .orb-label {
            font-size: 0.7em;
            color: var(--text-dim);
        }

        /* ===== XP BAR ===== */
        .xp-section {
            width: 100%;
            padding: 0 20px;
            margin-bottom: 15px;
        }

        .xp-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            margin-bottom: 5px;
        }

        .xp-label span:first-child {
            color: var(--gold);
            font-family: 'MedievalSharp', cursive;
        }

        .xp-bar {
            height: 20px;
            background: #0a0908;
            border: 2px solid var(--gold-dark);
            position: relative;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(180deg, var(--gold-light) 0%, var(--gold) 50%, var(--gold-dark) 100%);
            transition: width 0.5s;
        }

        .xp-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }

        /* ===== MENU BUTTONS ===== */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            width: 100%;
        }

        .menu-btn {
            min-height: 60px;
            background: linear-gradient(180deg, #1a1815 0%, #0f0e0c 100%);
            border: 2px solid var(--border);
            color: var(--gold);
            font-family: 'MedievalSharp', cursive;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .menu-btn:active {
            background: linear-gradient(180deg, #2a2825 0%, #1a1815 100%);
            border-color: var(--gold);
            transform: scale(0.98);
        }

        .menu-btn .icon {
            font-size: 1.5em;
        }

        /* ===== BOTTOM SHEET ===== */
        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 85vh;
            background: var(--bg-panel);
            border-top: 3px solid var(--gold-dark);
            border-radius: 20px 20px 0 0;
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .sheet-overlay.active .bottom-sheet {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 12px auto;
        }

        .sheet-header {
            padding: 10px 20px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sheet-title {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.3em;
            color: var(--gold);
        }

        .sheet-close {
            width: 36px;
            height: 36px;
            background: none;
            border: 2px solid var(--border);
            color: var(--text-dim);
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 50%;
        }

        .sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        /* ===== SPELLS ===== */
        .spell-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .spell-tab {
            padding: 8px 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 0.85em;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spell-tab.active {
            background: rgba(184,134,11,0.2);
            border-color: var(--gold-dark);
            color: var(--gold);
        }

        .spell-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .spell-icon {
            font-size: 2em;
            filter: drop-shadow(0 0 5px var(--purple));
        }

        .spell-info {
            flex: 1;
        }

        .spell-name {
            font-family: 'MedievalSharp', cursive;
            color: var(--gold-light);
            font-size: 1.05em;
        }

        .spell-level {
            color: var(--gold);
            font-size: 0.85em;
            letter-spacing: 2px;
        }

        .spell-desc {
            color: var(--text-dim);
            font-size: 0.85em;
            margin-top: 5px;
        }

        /* ===== KNOWLEDGE GRID ===== */
        .knowledge-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .knowledge-slot {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.4);
            border: 1px dashed var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
        }

        .knowledge-slot.filled {
            border-style: solid;
            background: rgba(30,26,22,0.8);
        }

        .knowledge-slot.filled .icon {
            filter: drop-shadow(0 0 5px var(--gold));
        }

        /* ===== STATS ===== */
        .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .stat-name {
            width: 40px;
            font-family: 'MedievalSharp', cursive;
            color: var(--gold);
            font-size: 0.9em;
        }

        .stat-label-text {
            width: 100px;
            font-size: 0.8em;
            color: var(--text-dim);
        }

        .stat-bar {
            flex: 1;
            height: 14px;
            background: #0a0908;
            border: 1px solid var(--border);
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold));
        }

        .stat-value {
            width: 35px;
            text-align: right;
            font-size: 0.85em;
        }

        /* ===== QUESTS ===== */
        .quest-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid rgba(61,53,41,0.4);
        }

        .quest-status {
            font-size: 1.2em;
        }

        .quest-info {
            flex: 1;
        }

        .quest-name {
            font-size: 0.95em;
        }

        .quest-item.done .quest-name {
            color: var(--text-dim);
            text-decoration: line-through;
        }

        .quest-item.active .quest-name {
            color: var(--gold);
        }

        .quest-date {
            font-size: 0.8em;
            color: var(--text-dim);
            margin-top: 3px;
        }

        /* ===== BACK BUTTON ===== */
        .back-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: var(--bg-panel);
            border: 2px solid var(--border);
            color: var(--text-dim);
            font-size: 1.2em;
            cursor: pointer;
            z-index: 100;
            display: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Back Button (for non-Telegram) -->
    <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê</button>

    <!-- Header -->
    <header class="header">
        <h1 id="charName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
        <div class="header-sub">–£—Ä–æ–≤–µ–Ω—å <span id="charLevel">?</span> ‚Ä¢ <span id="charClass">...</span></div>
    </header>

    <!-- Character Section -->
    <section class="character-section">
        <div class="particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>

        <svg class="character-svg" viewBox="0 0 200 280" fill="none">
            <defs>
                <filter id="glow"><feGaussianBlur stdDeviation="3"/></filter>
                <linearGradient id="robe" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" stop-color="#4a3a6a"/>
                    <stop offset="100%" stop-color="#1a1028"/>
                </linearGradient>
            </defs>
            <line x1="155" y1="50" x2="168" y2="240" stroke="#8b7355" stroke-width="7" stroke-linecap="round"/>
            <circle cx="155" cy="42" r="18" fill="#9370db" filter="url(#glow)"/>
            <circle cx="155" cy="42" r="10" fill="#b19cd9"/>
            <path d="M100 75 L55 255 L145 255 L100 75" fill="url(#robe)"/>
            <path d="M55 255 L35 275 L165 275 L145 255 Z" fill="#1a1028"/>
            <ellipse cx="100" cy="60" rx="38" ry="42" fill="#2a1a3a"/>
            <ellipse cx="100" cy="55" rx="28" ry="28" fill="#0a0a0a"/>
            <circle cx="88" cy="50" r="4" fill="#9370db" filter="url(#glow)"/>
            <circle cx="112" cy="50" r="4" fill="#9370db" filter="url(#glow)"/>
        </svg>

        <!-- Orbs -->
        <div class="orbs-row">
            <div class="orb orb-hp">
                <div class="orb-bg">
                    <div class="orb-fill" id="hpFill"></div>
                </div>
                <div class="orb-glass"></div>
                <div class="orb-frame"></div>
                <div class="orb-value">
                    <span id="hpValue">?/?</span>
                    <span class="orb-label">‚ù§Ô∏è HP</span>
                </div>
            </div>
            <div class="orb orb-mana">
                <div class="orb-bg">
                    <div class="orb-fill" id="manaFill"></div>
                </div>
                <div class="orb-glass"></div>
                <div class="orb-frame"></div>
                <div class="orb-value">
                    <span id="manaValue">?%</span>
                    <span class="orb-label">üíô –ö–æ–Ω—Ç–µ–∫—Å—Ç</span>
                </div>
            </div>
        </div>

        <!-- XP Bar -->
        <div class="xp-section">
            <div class="xp-label">
                <span>‚≠ê –û–ø—ã—Ç</span>
                <span id="xpLabel">?/? –∫–≤–µ—Å—Ç–æ–≤</span>
            </div>
            <div class="xp-bar">
                <div class="xp-fill" id="xpFill"></div>
                <div class="xp-text" id="xpText">?%</div>
            </div>
        </div>
    </section>

    <!-- Menu Buttons -->
    <nav class="menu-grid">
        <button class="menu-btn" onclick="openSheet('spells')">
            <span class="icon">üìñ</span>
            <span>–ö–Ω–∏–≥–∞ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–π</span>
        </button>
        <button class="menu-btn" onclick="openSheet('knowledge')">
            <span class="icon">üîÆ</span>
            <span>–°–≤–∏—Ç–∫–∏ –ó–Ω–∞–Ω–∏–π</span>
        </button>
        <button class="menu-btn" onclick="openSheet('stats')">
            <span class="icon">‚öóÔ∏è</span>
            <span>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</span>
        </button>
        <button class="menu-btn" onclick="openSheet('quests')">
            <span class="icon">üìú</span>
            <span>–ñ—É—Ä–Ω–∞–ª</span>
        </button>
    </nav>

    <!-- Bottom Sheet Overlay -->
    <div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()">
        <div class="bottom-sheet" onclick="event.stopPropagation()">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <div class="sheet-title" id="sheetTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>
                <button class="sheet-close" onclick="closeSheet()">‚úï</button>
            </div>
            <div class="sheet-content" id="sheetContent"></div>
        </div>
    </div>

    <script>
        // ===== TELEGRAM WEBAPP =====
        let tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram (–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—à —Å—Ç–∏–ª—å)
            document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#0c0a08');
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤–Ω–µ Telegram
            document.getElementById('backBtn').style.display = 'block';
        }

        // ===== DATA =====
        let DATA = null;

        async function loadData() {
            try {
                const res = await fetch('/api/data');
                DATA = await res.json();
                render();
            } catch (e) {
                console.error('Failed to load data:', e);
                // Fallback - –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
                const cached = localStorage.getItem('fantasyData');
                if (cached) {
                    DATA = JSON.parse(cached);
                    render();
                }
            }
        }

        // ===== RENDER =====
        function render() {
            if (!DATA) return;

            // Header
            document.getElementById('charName').textContent = DATA.character.name;
            document.getElementById('charLevel').textContent = DATA.character.level;
            document.getElementById('charClass').textContent = DATA.character.class;

            // HP
            const hpPct = (DATA.hp.current / DATA.hp.max) * 100;
            document.getElementById('hpFill').style.height = hpPct + '%';
            document.getElementById('hpValue').textContent = `${DATA.hp.current}/${DATA.hp.max}`;

            // Mana
            const manaPct = (DATA.mana.used / DATA.mana.max) * 100;
            document.getElementById('manaFill').style.height = manaPct + '%';
            document.getElementById('manaValue').textContent = Math.round(manaPct) + '%';

            // XP
            const xpPct = (DATA.xp.current / DATA.xp.total) * 100;
            document.getElementById('xpFill').style.width = xpPct + '%';
            document.getElementById('xpText').textContent = Math.round(xpPct) + '%';
            document.getElementById('xpLabel').textContent = `${DATA.xp.current}/${DATA.xp.total} –∫–≤–µ—Å—Ç–æ–≤`;

            // Cache data
            localStorage.setItem('fantasyData', JSON.stringify(DATA));
        }

        // ===== SHEETS =====
        function openSheet(type) {
            const overlay = document.getElementById('sheetOverlay');
            const title = document.getElementById('sheetTitle');
            const content = document.getElementById('sheetContent');

            let html = '';

            switch(type) {
                case 'spells':
                    title.textContent = 'üìñ –ö–Ω–∏–≥–∞ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–π';
                    html = renderSpells();
                    break;
                case 'knowledge':
                    title.textContent = 'üîÆ –°–≤–∏—Ç–∫–∏ –ó–Ω–∞–Ω–∏–π';
                    html = renderKnowledge();
                    break;
                case 'stats':
                    title.textContent = '‚öóÔ∏è –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏';
                    html = renderStats();
                    break;
                case 'quests':
                    title.textContent = 'üìú –ñ—É—Ä–Ω–∞–ª –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–π';
                    html = renderQuests();
                    break;
            }

            content.innerHTML = html;
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSheet() {
            document.getElementById('sheetOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function renderSpells() {
            if (!DATA?.spells?.length) return '<p>–ù–µ—Ç –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π</p>';

            const categories = {};
            DATA.spells.forEach(s => {
                if (!categories[s.category]) categories[s.category] = [];
                categories[s.category].push(s);
            });

            let html = '<div class="spell-tabs">';
            const cats = Object.keys(categories);
            cats.forEach((cat, i) => {
                html += `<button class="spell-tab ${i === 0 ? 'active' : ''}" onclick="filterSpells('${cat}', this)">${cat}</button>`;
            });
            html += '</div><div id="spellsList">';

            // Show first category by default
            if (cats.length > 0) {
                categories[cats[0]].forEach(s => {
                    const stars = '‚òÖ'.repeat(s.level) + '‚òÜ'.repeat(5 - s.level);
                    html += `
                        <div class="spell-card">
                            <div class="spell-icon">${s.icon}</div>
                            <div class="spell-info">
                                <div class="spell-name">${s.name}</div>
                                <div class="spell-level">${stars}</div>
                                <div class="spell-desc">${s.desc}</div>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div>';
            return html;
        }

        function filterSpells(category, btn) {
            // Update tabs
            document.querySelectorAll('.spell-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');

            // Filter spells
            const spells = DATA.spells.filter(s => s.category === category);
            let html = '';
            spells.forEach(s => {
                const stars = '‚òÖ'.repeat(s.level) + '‚òÜ'.repeat(5 - s.level);
                html += `
                    <div class="spell-card">
                        <div class="spell-icon">${s.icon}</div>
                        <div class="spell-info">
                            <div class="spell-name">${s.name}</div>
                            <div class="spell-level">${stars}</div>
                            <div class="spell-desc">${s.desc}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('spellsList').innerHTML = html;
        }

        function renderKnowledge() {
            let html = '<div class="knowledge-grid">';
            const total = 12;
            for (let i = 0; i < total; i++) {
                const item = DATA.knowledge?.[i];
                if (item) {
                    html += `<div class="knowledge-slot filled"><span class="icon">${item.icon}</span></div>`;
                } else {
                    html += `<div class="knowledge-slot"></div>`;
                }
            }
            html += '</div>';
            return html;
        }

        function renderStats() {
            if (!DATA?.stats) return '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';

            let html = '';
            for (const [key, stat] of Object.entries(DATA.stats)) {
                html += `
                    <div class="stat-row">
                        <div class="stat-name">${key}</div>
                        <div class="stat-label-text">${stat.label}</div>
                        <div class="stat-bar">
                            <div class="stat-fill" style="width: ${stat.value}%"></div>
                        </div>
                        <div class="stat-value">${stat.value}%</div>
                    </div>
                `;
            }
            return html;
        }

        function renderQuests() {
            if (!DATA?.quests?.length) return '<p>–ù–µ—Ç –∫–≤–µ—Å—Ç–æ–≤</p>';

            let html = '';
            // Sort: active first, then by date
            const sorted = [...DATA.quests].sort((a, b) => {
                if (a.status === 'active' && b.status !== 'active') return -1;
                if (a.status !== 'active' && b.status === 'active') return 1;
                return new Date(b.date) - new Date(a.date);
            });

            sorted.forEach(q => {
                const icon = q.status === 'done' ? '‚úÖ' : '‚è≥';
                html += `
                    <div class="quest-item ${q.status}">
                        <div class="quest-status">${icon}</div>
                        <div class="quest-info">
                            <div class="quest-name">${q.name}</div>
                            <div class="quest-date">${q.date}</div>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        function goBack() {
            if (tg) {
                tg.close();
            } else {
                window.history.back();
            }
        }

        // ===== INIT =====
        loadData();
    </script>
</body>
</html>
